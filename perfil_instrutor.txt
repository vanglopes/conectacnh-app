<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#06b6d4">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Instrutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style> .font-serif-custom { font-family: 'Georgia', serif; } </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-24">

    <div class="bg-white p-6 pt-8 pb-4 shadow-sm sticky top-0 z-10 flex items-center gap-4">
        <a href="dashboard_instrutor.html" class="text-slate-400 hover:text-slate-600">
            <i class="fa-solid fa-arrow-left text-xl"></i>
        </a>
        <h1 class="text-xl font-bold text-slate-900">Editar Perfil</h1>
    </div>

    <div class="p-6 text-center">
        <div class="relative w-28 h-28 mx-auto mb-4 group cursor-pointer">
            <img id="img-perfil" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-full h-full rounded-full object-cover border-4 border-white shadow-lg bg-slate-200">
            <div class="absolute inset-0 bg-black/30 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fa-solid fa-camera text-white"></i>
            </div>
        </div>
        <h2 id="txt-nome" class="text-xl font-bold">Carregando...</h2>
        <p class="text-sm text-slate-500">Instrutor Credenciado</p>
    </div>

    <div class="px-6 space-y-5">
        
        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-4">
            <h3 class="text-sm font-bold text-cyan-600 flex items-center gap-2">
                <i class="fa-solid fa-briefcase"></i> Dados da Aula
            </h3>
            
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Preço da Aula (50 min)</label>
                <div class="flex items-center gap-3">
                    <span class="text-lg font-bold text-slate-400">R$</span>
                    <input type="number" id="input-preco" step="0.50" class="w-full text-2xl font-bold text-slate-900 outline-none border-b border-slate-100 focus:border-cyan-500 transition-colors pb-1" placeholder="0.00">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Categorias</label>
                <input type="text" id="input-categorias" disabled class="w-full font-medium text-slate-400 outline-none bg-slate-50 p-2 rounded cursor-not-allowed text-sm">
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-4">
            <h3 class="text-sm font-bold text-cyan-600 flex items-center gap-2">
                <i class="fa-solid fa-address-card"></i> Pessoal e Contato
            </h3>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Telefone / WhatsApp <span class="text-red-400">*</span></label>
                <input type="text" id="input-telefone" oninput="mascaraTelefone(this)" maxlength="15" placeholder="(00) 90000-0000" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-cyan-500 outline-none transition-colors">
                <p class="text-[10px] text-slate-400 mt-1">Essencial para o aluno entrar em contato.</p>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ponto de Encontro (Endereço)</label>
                <input type="text" id="input-endereco" placeholder="Ex: Estação de Metrô, Autoescola..." class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-cyan-500 outline-none transition-colors">
                <p class="text-[10px] text-slate-400 mt-1">Local onde as aulas iniciam.</p>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">CPF</label>
                <input type="text" id="input-cpf" oninput="mascaraCPF(this)" maxlength="14" placeholder="000.000.000-00" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-slate-800 focus:border-cyan-500 outline-none transition-colors">
            </div>
        </div>
        
        <div class="pt-4">
            <button onclick="fazerLogout()" class="w-full text-red-500 font-bold text-sm py-3 hover:bg-red-50 rounded-lg transition-colors">
                Sair da Conta
            </button>
        </div>

    </div>

    <div class="fixed bottom-0 w-full bg-white border-t border-slate-100 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50 max-w-md left-1/2 -translate-x-1/2">
        <button onclick="salvarAlteracoes()" id="btn-salvar" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition-colors flex items-center justify-center gap-2">
            Salvar Alterações
        </button>
    </div>

    <script>
        const SUPABASE_URL = 'https://gfazevzzvgafmlnmkgjo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmYXpldnp6dmdhZm1sbm1rZ2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDE3MjMsImV4cCI6MjA4MTUxNzcyM30.00SUzPZP0-YCxwaynA0Eu8lBM2O7E4Sp52lwLVACRSo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let instrutorId = null;
        let usuarioId = null;

        // 1. CARREGAR DADOS COMPLETOS
        window.onload = async function() {
            const userStr = localStorage.getItem('usuario_logado');
            if(!userStr) { window.location.href = 'index.html'; return; }
            const usuario = JSON.parse(userStr);
            usuarioId = usuario.id;

            // Busca Instrutor + Dados do Usuário (Telefone/CPF)
            // .select('*, usuarios(*)') faz um JOIN mágico
            const { data: instrutor, error } = await supabaseClient
                .from('instrutores')
                .select('*, usuarios(*)')
                .eq('usuario_id', usuario.id)
                .single();

            if (error || !instrutor) {
                alert("Erro ao carregar perfil.");
                return;
            }

            instrutorId = instrutor.id;

            // --- PREENCHER TELA ---
            document.getElementById('txt-nome').innerText = instrutor.nome;
            document.getElementById('img-perfil').src = instrutor.foto_url || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            
            // Dados Profissionais (Tabela Instrutores)
            document.getElementById('input-preco').value = instrutor.preco_aula;
            document.getElementById('input-endereco').value = instrutor.endereco || ''; // Endereço de trabalho
            
            if(instrutor.categorias) {
                document.getElementById('input-categorias').value = instrutor.categorias.join(', ');
            } else {
                document.getElementById('input-categorias').value = instrutor.categoria || 'Não informado';
            }

            // Dados Pessoais (Tabela Usuarios)
            // Acessamos via instrutor.usuarios.campo
            if (instrutor.usuarios) {
                document.getElementById('input-telefone').value = instrutor.usuarios.telefone || '';
                document.getElementById('input-cpf').value = instrutor.usuarios.cpf || '';
            }
        };

        // --- MÁSCARAS ---
        function mascaraTelefone(i) {
            let v = i.value.replace(/\D/g, "");
            v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
            v = v.replace(/(\d)(\d{4})$/, "$1-$2");
            i.value = v;
        }
        function mascaraCPF(i) {
            let v = i.value.replace(/\D/g, "");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d)/, "$1.$2");
            v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            i.value = v;
        }

        // --- SALVAR (O GRANDE TRUQUE) ---
        async function salvarAlteracoes() {
            const btn = document.getElementById('btn-salvar');
            const preco = document.getElementById('input-preco').value;
            const endereco = document.getElementById('input-endereco').value;
            const telefone = document.getElementById('input-telefone').value;
            const cpf = document.getElementById('input-cpf').value;

            if (!preco || preco <= 0) return alert("Preço inválido.");
            if (!telefone) return alert("O telefone é obrigatório para contato.");

            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> Salvando...';
            btn.disabled = true;

            // 1. Atualiza Tabela INSTRUTORES (Preço e Local de Atendimento)
            const { error: errInstr } = await supabaseClient
                .from('instrutores')
                .update({ 
                    preco_aula: preco,
                    endereco: endereco 
                })
                .eq('id', instrutorId);

            if (errInstr) {
                alert("Erro ao salvar dados profissionais: " + errInstr.message);
                btn.innerText = "Tentar Novamente";
                btn.disabled = false;
                return;
            }

            // 2. Atualiza Tabela USUARIOS (Telefone e CPF)
            const { error: errUser } = await supabaseClient
                .from('usuarios')
                .update({ 
                    telefone: telefone,
                    cpf: cpf
                })
                .eq('id', usuarioId);

            if (errUser) {
                alert("Dados profissionais salvos, mas erro nos dados pessoais: " + errUser.message);
            } else {
                btn.className = "w-full bg-green-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition-colors flex items-center justify-center gap-2";
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Perfil Atualizado!';
                setTimeout(() => { window.location.href = 'dashboard_instrutor.html'; }, 1500);
            }
        }

        function fazerLogout() {
            if(confirm("Tem certeza que deseja sair?")) {
                localStorage.removeItem('usuario_logado');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>